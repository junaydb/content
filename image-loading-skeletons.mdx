---
title: "Preventing CLS with Astro's inferRemoteSize()"
order: 1
published: true
rows:
  - type: text
    title: Technology
    items:
      - Astro
      - Typescript
---

import ImageModal from "@/astro/ImageModal.astro";
export const components = { img: ImageModal };

Recently, I made this component that displays a skeleton whilst an image is loading:
![initial_blockout](https://plus.unsplash.com/premium_photo-1673264933048-3bd3f5b86f9d?fm=jpg&q=60&w=3000&ixlib=rb-4.0.3&ixid=M3wxMjA3fDB8MHxzZWFyY2h8MXx8d2FsbHBhcGVyJTIwNGt8ZW58MHx8MHx8fDA%3D)

I've used a large image here so you hopefully should have seen the loading skeleton.
However, if you've got blazingly fast internet, you might have to open your browser's dev tools and throttle your network to see it in action (disable your cache too).

Also, If you're interested, you can view the source code for this component [here](https://github.com/junaydb/website/blob/4d6556ee19a77e5bc15e0c6d33cba776c93348ab/src/astro/ImageModal.astro)

To make this component as useful as possible it needed to support images of any size, which came with the challenge of figuring out how to avoid cumulative layout shift (CLS).

This is because when the browser doesn't know the size of the image ahead of time, no space for the image is reserved on the page until it has been fetched,
at which point you see a nasty layout shift caused by the browser updating the layout to make space for the image and it's very jarring for users.

To fix this, we need to ensure we set the width and height of the image ahead of time, so that the browser reserves the correct amount of space even before the image has loaded.

This site is built with [Astro](https://astro.build/), a super-charged static-site generator, meaning I could fetch the image at build time to check it's dimensions.
Astro makes this super easy with their `inferRemoteSize()` function:

```js
---
import { inferRemoteSize } from "astro:assets";

const { src, alt } = Astro.props;
const { width, height } = await inferRemoteSize(src);
---

<img
  src={src}
  alt={alt}
  width={width}
  height={height}
/>
```

The code inside the code fences runs at build time on the server.

Just like that, we have the size of the image at build time. We use this to set the width and height of this image which correctly reserves the space for the image even before the client's browser fetches it, successfully preventing CLS.

Under the hood, `inferRemoteSize()` uses a slightly modified version of the [`image-size`](https://github.com/image-size/image-size) package, so check that out if you're not using Astro.
